<?php
/**
 * Test malware detection
 * SpusÅ¥te tento soubor z pÅ™Ã­kazovÃ© Å™Ã¡dky nebo pÅ™es browser
 */

// PÅ™idejte cestu k WordPress
define('WP_USE_THEMES', false);
require_once(__DIR__ . '/../../../wp-load.php');

// Zkontrolujte, zda je plugin aktivnÃ­
if (!class_exists('WP_Security_Guardian')) {
    die('WP Security Guardian plugin nenÃ­ aktivnÃ­!');
}

// ZÃ­skejte instanci pluginu
$wpsg = WP_Security_Guardian::get_instance();

// TestovacÃ­ soubor path
$test_file = ABSPATH . 'wp-content/themes/unifer-base-theme/test-malware.php';

echo "<h2>ğŸ” Test detekce malware</h2>\n";
echo "<p>TestovacÃ­ soubor: {$test_file}</p>\n";

// Zkontrolujte, zda soubor existuje
if (!file_exists($test_file)) {
    die('âŒ TestovacÃ­ soubor neexistuje: ' . $test_file);
}

echo "<p>âœ… TestovacÃ­ soubor existuje</p>\n";

// PÅ™eÄtÄ›te obsah souboru
$content = file_get_contents($test_file);
echo "<h3>ğŸ“„ Obsah souboru:</h3>\n";
echo "<pre style='background:#f5f5f5; padding:10px; border:1px solid #ccc;'>\n";
echo htmlspecialchars($content);
echo "</pre>\n";

// Test malware skenovÃ¡nÃ­ pomocÃ­ reflection (protoÅ¾e metoda je private)
try {
    $reflection = new ReflectionClass($wpsg);
    $method = $reflection->getMethod('scan_file_for_malware');
    $method->setAccessible(true);
    
    echo "<h3>ğŸ”¬ SpouÅ¡tÃ­m malware scan...</h3>\n";
    
    $result = $method->invoke($wpsg, $test_file);
    
    if ($result && isset($result['threat_detected']) && $result['threat_detected']) {
        echo "<div style='color: green; font-weight: bold; padding: 10px; border: 2px solid green; background: #e8f5e8;'>\n";
        echo "âœ… ÃšSPÄšCH: Plugin detekoval malware!\n";
        echo "<br>Risk Level: " . $result['risk_level'] . "\n";
        echo "<br>DÅ¯vod: " . $result['reason'] . "\n";
        if (isset($result['patterns_found'])) {
            echo "<br>NalezenÃ© vzory: " . implode(', ', $result['patterns_found']) . "\n";
        }
        echo "</div>\n";
    } else {
        echo "<div style='color: red; font-weight: bold; padding: 10px; border: 2px solid red; background: #f5e8e8;'>\n";
        echo "âŒ CHYBA: Plugin nedetekoval malware!\n";
        echo "<br>VÃ½sledek: " . json_encode($result, JSON_PRETTY_PRINT) . "\n";
        echo "</div>\n";
    }
    
} catch (Exception $e) {
    echo "<div style='color: red; font-weight: bold;'>\n";
    echo "âŒ Chyba pÅ™i testovÃ¡nÃ­: " . $e->getMessage() . "\n";
    echo "</div>\n";
}

// Test enhanced security scan
if (class_exists('WPSG_Enhanced_Security')) {
    echo "<h3>ğŸ” Enhanced Security Scan...</h3>\n";
    
    try {
        $enhanced_result = WPSG_Enhanced_Security::advanced_malware_scan($content);
        
        if ($enhanced_result && $enhanced_result['risk_level'] === 'high') {
            echo "<div style='color: green; font-weight: bold; padding: 10px; border: 2px solid green; background: #e8f5e8;'>\n";
            echo "âœ… ÃšSPÄšCH: Enhanced Security detekovala vysokÃ© riziko!\n";
            echo "<br>Risk Level: " . $enhanced_result['risk_level'] . "\n";
            echo "<br>Pattern Score: " . $enhanced_result['pattern_score'] . "\n";
            echo "<br>Entropie: " . $enhanced_result['entropy'] . "\n";
            echo "<br>DoporuÄenÃ­: " . $enhanced_result['recommendation'] . "\n";
            echo "</div>\n";
        } else {
            echo "<div style='color: orange; font-weight: bold; padding: 10px; border: 2px solid orange; background: #fff8e8;'>\n";
            echo "âš ï¸ Enhanced Security vÃ½sledek:\n";
            echo "<br>" . json_encode($enhanced_result, JSON_PRETTY_PRINT) . "\n";
            echo "</div>\n";
        }
        
    } catch (Exception $e) {
        echo "<div style='color: red; font-weight: bold;'>\n";
        echo "âŒ Chyba Enhanced Security: " . $e->getMessage() . "\n";
        echo "</div>\n";
    }
}

echo "<h3>ğŸ’¡ DalÅ¡Ã­ kroky:</h3>\n";
echo "<ul>\n";
echo "<li>Zkontrolujte Security Logs v pluginu</li>\n";
echo "<li>OvÄ›Å™te, zda byl soubor umÃ­stÄ›n do karantÃ©ny</li>\n";
echo "<li>Po testu nezapomeÅˆte smazat testovacÃ­ soubor!</li>\n";
echo "</ul>\n";

echo "<p style='color: red; font-weight: bold;'>âš ï¸ DÅ®LEÅ½ITÃ‰: Po dokonÄenÃ­ testu smaÅ¾e testovacÃ­ soubor, protoÅ¾e obsahuje nebezpeÄnÃ½ kÃ³d!</p>\n";
?>