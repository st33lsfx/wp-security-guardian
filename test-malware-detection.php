<?php
/**
 * Test malware detection
 * Spusťte tento soubor z příkazové řádky nebo přes browser
 */

// Přidejte cestu k WordPress
define('WP_USE_THEMES', false);
require_once(__DIR__ . '/../../../wp-load.php');

// Zkontrolujte, zda je plugin aktivní
if (!class_exists('WP_Security_Guardian')) {
    die('WP Security Guardian plugin není aktivní!');
}

// Získejte instanci pluginu
$wpsg = WP_Security_Guardian::get_instance();

// Testovací soubor path
$test_file = ABSPATH . 'wp-content/themes/unifer-base-theme/test-malware.php';

echo "<h2>🔍 Test detekce malware</h2>\n";
echo "<p>Testovací soubor: {$test_file}</p>\n";

// Zkontrolujte, zda soubor existuje
if (!file_exists($test_file)) {
    die('❌ Testovací soubor neexistuje: ' . $test_file);
}

echo "<p>✅ Testovací soubor existuje</p>\n";

// Přečtěte obsah souboru
$content = file_get_contents($test_file);
echo "<h3>📄 Obsah souboru:</h3>\n";
echo "<pre style='background:#f5f5f5; padding:10px; border:1px solid #ccc;'>\n";
echo htmlspecialchars($content);
echo "</pre>\n";

// Test malware skenování pomocí reflection (protože metoda je private)
try {
    $reflection = new ReflectionClass($wpsg);
    $method = $reflection->getMethod('scan_file_for_malware');
    $method->setAccessible(true);
    
    echo "<h3>🔬 Spouštím malware scan...</h3>\n";
    
    $result = $method->invoke($wpsg, $test_file);
    
    if ($result && isset($result['threat_detected']) && $result['threat_detected']) {
        echo "<div style='color: green; font-weight: bold; padding: 10px; border: 2px solid green; background: #e8f5e8;'>\n";
        echo "✅ ÚSPĚCH: Plugin detekoval malware!\n";
        echo "<br>Risk Level: " . $result['risk_level'] . "\n";
        echo "<br>Důvod: " . $result['reason'] . "\n";
        if (isset($result['patterns_found'])) {
            echo "<br>Nalezené vzory: " . implode(', ', $result['patterns_found']) . "\n";
        }
        echo "</div>\n";
    } else {
        echo "<div style='color: red; font-weight: bold; padding: 10px; border: 2px solid red; background: #f5e8e8;'>\n";
        echo "❌ CHYBA: Plugin nedetekoval malware!\n";
        echo "<br>Výsledek: " . json_encode($result, JSON_PRETTY_PRINT) . "\n";
        echo "</div>\n";
    }
    
} catch (Exception $e) {
    echo "<div style='color: red; font-weight: bold;'>\n";
    echo "❌ Chyba při testování: " . $e->getMessage() . "\n";
    echo "</div>\n";
}

// Test enhanced security scan
if (class_exists('WPSG_Enhanced_Security')) {
    echo "<h3>🔍 Enhanced Security Scan...</h3>\n";
    
    try {
        $enhanced_result = WPSG_Enhanced_Security::advanced_malware_scan($content);
        
        if ($enhanced_result && $enhanced_result['risk_level'] === 'high') {
            echo "<div style='color: green; font-weight: bold; padding: 10px; border: 2px solid green; background: #e8f5e8;'>\n";
            echo "✅ ÚSPĚCH: Enhanced Security detekovala vysoké riziko!\n";
            echo "<br>Risk Level: " . $enhanced_result['risk_level'] . "\n";
            echo "<br>Pattern Score: " . $enhanced_result['pattern_score'] . "\n";
            echo "<br>Entropie: " . $enhanced_result['entropy'] . "\n";
            echo "<br>Doporučení: " . $enhanced_result['recommendation'] . "\n";
            echo "</div>\n";
        } else {
            echo "<div style='color: orange; font-weight: bold; padding: 10px; border: 2px solid orange; background: #fff8e8;'>\n";
            echo "⚠️ Enhanced Security výsledek:\n";
            echo "<br>" . json_encode($enhanced_result, JSON_PRETTY_PRINT) . "\n";
            echo "</div>\n";
        }
        
    } catch (Exception $e) {
        echo "<div style='color: red; font-weight: bold;'>\n";
        echo "❌ Chyba Enhanced Security: " . $e->getMessage() . "\n";
        echo "</div>\n";
    }
}

echo "<h3>💡 Další kroky:</h3>\n";
echo "<ul>\n";
echo "<li>Zkontrolujte Security Logs v pluginu</li>\n";
echo "<li>Ověřte, zda byl soubor umístěn do karantény</li>\n";
echo "<li>Po testu nezapomeňte smazat testovací soubor!</li>\n";
echo "</ul>\n";

echo "<p style='color: red; font-weight: bold;'>⚠️ DŮLEŽITÉ: Po dokončení testu smaže testovací soubor, protože obsahuje nebezpečný kód!</p>\n";
?>