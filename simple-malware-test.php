<?php
/**
 * Simple malware detection test - bez WordPress zÃ¡vislostÃ­
 */

echo "<h2>ğŸ” JednoduchÃ½ test malware detekce</h2>\n";

// TestovacÃ­ soubor
$test_file = '/Users/ondrejnemec/Local Sites/base-claude/app/public/wp-content/themes/unifer-base-theme/test-malware.php';

if (!file_exists($test_file)) {
    die('âŒ TestovacÃ­ soubor neexistuje: ' . $test_file);
}

echo "<p>âœ… TestovacÃ­ soubor existuje</p>\n";

// PÅ™eÄtÄ›te obsah
$content = file_get_contents($test_file);
echo "<h3>ğŸ“„ Obsah testovacÃ­ho souboru:</h3>\n";
echo "<pre style='background:#f5f5f5; padding:10px; border:1px solid #ccc;'>\n";
echo htmlspecialchars($content);
echo "</pre>\n";

echo "<h3>ğŸ”¬ SpouÅ¡tÃ­m malware detekci...</h3>\n";

// Enhanced malware patterns - pÅ™esnÄ› jako v pluginu
$malware_patterns = array(
    // PHP backdoors a webshells - enhanced detection
    '/eval\s*\(\s*base64_decode\s*\(/i' => array('score' => 5, 'type' => 'PHP_BACKDOOR'),
    '/eval\s*\(\s*gzinflate\s*\(/i' => array('score' => 5, 'type' => 'PHP_BACKDOOR'),
    '/eval\s*\(\s*str_rot13\s*\(/i' => array('score' => 4, 'type' => 'PHP_BACKDOOR'),
    '/eval\s*\(\s*\$_[GET|POST|REQUEST|COOKIE]/i' => array('score' => 5, 'type' => 'PHP_BACKDOOR_DIRECT'),
    '/eval\s*\([^)]*\$_[GET|POST|REQUEST|COOKIE]/i' => array('score' => 4, 'type' => 'PHP_BACKDOOR_INDIRECT'),
    '/system\s*\(\s*\$_[GET|POST|REQUEST]/i' => array('score' => 5, 'type' => 'COMMAND_INJECTION'),
    '/exec\s*\(\s*\$_[GET|POST|REQUEST]/i' => array('score' => 5, 'type' => 'COMMAND_INJECTION'),
    '/shell_exec\s*\(\s*\$_[GET|POST|REQUEST]/i' => array('score' => 5, 'type' => 'COMMAND_INJECTION'),
    '/passthru\s*\(\s*\$_[GET|POST|REQUEST]/i' => array('score' => 5, 'type' => 'COMMAND_INJECTION'),
    '/\bbase64_decode\s*\(\s*["\'][\w+\/=]+["\']\s*\)/i' => array('score' => 3, 'type' => 'OBFUSCATION'),
    '/\$_[A-Z]+\[\w+\]\s*\(\s*\$/i' => array('score' => 4, 'type' => 'VARIABLE_FUNCTION'),
    '/create_function\s*\(/i' => array('score' => 4, 'type' => 'DEPRECATED_FUNCTION'),
    
    // File operations
    '/file_get_contents\s*\(\s*["\']https?:\/\//i' => array('score' => 3, 'type' => 'REMOTE_FILE_INCLUDE'),
    '/fwrite\s*\([^)]*\$_[GET|POST|REQUEST]/i' => array('score' => 4, 'type' => 'FILE_WRITE_INJECTION'),
    
    // Network operations
    '/curl_exec\s*\(/i' => array('score' => 2, 'type' => 'HTTP_REQUEST'),
    '/fsockopen\s*\(/i' => array('score' => 3, 'type' => 'SOCKET_CONNECTION'),
    
    // Obfuscation patterns
    '/[a-zA-Z_\x7f-\xff][a-zA-Z0-9_\x7f-\xff]*\s*=\s*["\'][^"\']*\\\\x[0-9a-f]{2}/i' => array('score' => 3, 'type' => 'HEX_OBFUSCATION'),
    '/preg_replace\s*\(\s*["\']\/.*\/e["\']/' => array('score' => 4, 'type' => 'PREG_REPLACE_EVAL'),
);

$threats = array();
$threat_score = 0;

foreach ($malware_patterns as $pattern => $info) {
    if (preg_match($pattern, $content, $matches)) {
        $threat_score += $info['score'];
        $threats[] = array(
            'type' => $info['type'],
            'score' => $info['score'],
            'pattern' => $pattern,
            'match' => isset($matches[0]) ? $matches[0] : 'N/A'
        );
        
        echo "<div style='color: red; font-weight: bold; margin: 10px 0; padding: 10px; border: 2px solid red; background: #ffe6e6;'>\n";
        echo "ğŸš¨ MALWARE DETEKOVÃNO!\n";
        echo "<br>Typ: " . $info['type'] . "\n";
        echo "<br>SkÃ³re: " . $info['score'] . "\n";
        echo "<br>Vzor: " . htmlspecialchars($pattern) . "\n";
        echo "<br>Shoda: " . htmlspecialchars($matches[0]) . "\n";
        echo "</div>\n";
    }
}

// CelkovÃ© vÃ½sledky
echo "<h3>ğŸ“Š CelkovÃ© vÃ½sledky:</h3>\n";
echo "<div style='padding: 15px; border: 2px solid " . ($threat_score >= 5 ? 'red' : ($threat_score >= 3 ? 'orange' : 'green')) . "; background: " . ($threat_score >= 5 ? '#ffe6e6' : ($threat_score >= 3 ? '#fff8dc' : '#e6ffe6')) . ";'>\n";

if (count($threats) > 0) {
    echo "<strong>âš ï¸ CELKOVÃ‰ THREAT SKÃ“RE: " . $threat_score . "</strong><br>\n";
    echo "PoÄet detekovanÃ½ch hrozeb: " . count($threats) . "<br>\n";
    
    if ($threat_score >= 5) {
        echo "<strong style='color: red;'>ğŸ”´ VYSOKÃ‰ RIZIKO - Soubor obsahuje malware!</strong>\n";
    } elseif ($threat_score >= 3) {
        echo "<strong style='color: orange;'>ğŸŸ¡ STÅ˜EDNÃ RIZIKO - PodezÅ™elÃ½ obsah</strong>\n";
    } else {
        echo "<strong style='color: green;'>ğŸŸ¢ NÃZKÃ‰ RIZIKO</strong>\n";
    }
} else {
    echo "<strong style='color: green;'>âœ… Å½Ã¡dnÃ© malware vzory nebyly detekovÃ¡ny</strong>\n";
}
echo "</div>\n";

echo "<h3>ğŸ§ª DodateÄnÃ© testy:</h3>\n";

// Test na eval s $_POST
if (preg_match('/eval\s*\(\s*\$_POST/', $content)) {
    echo "<div style='color: red; font-weight: bold; margin: 10px 0;'>ğŸš¨ DetekovÃ¡n eval(\$_POST) - VYSOKÃ‰ RIZIKO!</div>\n";
} else {
    echo "<div style='color: orange;'>âš ï¸ eval(\$_POST) nebyl detekovÃ¡n</div>\n";
}

// Test na jakÃ½koliv eval
if (preg_match('/eval\s*\(/i', $content)) {
    echo "<div style='color: red; font-weight: bold; margin: 10px 0;'>ğŸš¨ DetekovÃ¡na funkce eval() - RIZIKO!</div>\n";
} else {
    echo "<div style='color: green;'>âœ… Funkce eval() nebyla nalezena</div>\n";
}

echo "<p style='color: red; font-weight: bold; margin-top: 20px;'>âš ï¸ DÅ®LEÅ½ITÃ‰: Po dokonÄenÃ­ testu smaÅ¾e testovacÃ­ soubor!</p>\n";
echo "<button onclick=\"if(confirm('Opravdu smazat testovacÃ­ soubor?')) { window.location.href='?delete=1'; }\">ğŸ—‘ï¸ Smazat testovacÃ­ soubor</button>\n";

// SmazÃ¡nÃ­ souboru pokud je poÅ¾adovÃ¡no
if (isset($_GET['delete']) && $_GET['delete'] == '1') {
    if (unlink($test_file)) {
        echo "<div style='color: green; font-weight: bold; margin: 10px 0;'>âœ… TestovacÃ­ soubor byl ÃºspÄ›Å¡nÄ› smazÃ¡n!</div>\n";
    } else {
        echo "<div style='color: red; font-weight: bold; margin: 10px 0;'>âŒ Chyba pÅ™i mazÃ¡nÃ­ testovacÃ­ho souboru!</div>\n";
    }
}
?>